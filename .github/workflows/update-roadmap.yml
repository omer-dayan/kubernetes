name: Update Scheduler Roadmap

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI
  push:
    branches:
      - master
    paths:
      - '.github/workflows/update-roadmap.yml'

jobs:
  update-roadmap:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and analyze sig/scheduling issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Fetching sig/scheduling issues from kubernetes/kubernetes..."

          # Fetch issues from kubernetes/kubernetes
          gh issue list \
            --repo kubernetes/kubernetes \
            --state open \
            --label "sig/scheduling" \
            --limit 100 \
            --json number,title,url,body,labels,createdAt > /tmp/issues.json

          TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)
          echo "Found $TOTAL_ISSUES sig/scheduling issues"

          # Calculate priority scores and sort
          echo "ðŸ“Š Analyzing and prioritizing issues..."

          jq -c '.[]' /tmp/issues.json | while IFS= read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            url=$(echo "$issue" | jq -r '.url')
            labels=$(echo "$issue" | jq -r '[.labels[]?.name] | join(", ")')
            created=$(echo "$issue" | jq -r '.createdAt')
            body=$(echo "$issue" | jq -r '.body // ""')

            # Calculate priority score
            score=0

            # Priority labels
            if echo "$labels" | grep -q "priority/critical-urgent"; then
              score=$((score + 1000))
            elif echo "$labels" | grep -q "priority/important-soon"; then
              score=$((score + 500))
            elif echo "$labels" | grep -q "priority/important-longterm"; then
              score=$((score + 200))
            fi

            # Kind labels
            if echo "$labels" | grep -q "kind/regression"; then
              score=$((score + 400))
            elif echo "$labels" | grep -q "kind/bug"; then
              score=$((score + 300))
            fi

            # Keywords
            text=$(echo "$title $body" | tr '[:upper:]' '[:lower:]')
            if echo "$text" | grep -qE "crash|panic|broken"; then
              score=$((score + 250))
            elif echo "$text" | grep -qE "not work|fail|error"; then
              score=$((score + 150))
            fi

            # Output: score|number|title|url|labels
            echo "${score}|${number}|${title}|${url}|${labels}"
          done | sort -t'|' -k1 -nr > /tmp/scored_issues.txt

          echo "âœ… Analysis complete"

      - name: Generate roadmap
        run: |
          echo "ðŸ“ Generating roadmap..."
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)

          cat > roadmap.md << 'ROADMAP_HEADER'
          # Kubernetes Scheduler - Top 10 Priority Issues

          **Updated:** TIMESTAMP_PLACEHOLDER
          **Source:** kubernetes/kubernetes (sig/scheduling)
          **Total Open Issues:** TOTAL_ISSUES_PLACEHOLDER
          **Showing:** Top 10 highest priority

          ---

          ## ðŸŽ¯ Critical Focus Areas

          The following issues represent the highest priority items for SIG Scheduling based on:
          - Priority labels (critical-urgent, important-soon)
          - Issue type (bugs, regressions)
          - Impact keywords (crash, broken, not working)
          - Issue age and community attention

          ---

          ## ðŸ“‹ Top 10 Issues

          ROADMAP_HEADER

          # Replace placeholders
          sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/" roadmap.md
          sed -i "s/TOTAL_ISSUES_PLACEHOLDER/$TOTAL_ISSUES/" roadmap.md

          # Add top 10 issues
          rank=1
          head -10 /tmp/scored_issues.txt | while IFS='|' read -r score number title url labels; do
            # Determine priority
            if [ $score -ge 800 ]; then
              emoji="ðŸ”´"
              priority="CRITICAL"
            elif [ $score -ge 400 ]; then
              emoji="ðŸŸ "
              priority="HIGH"
            elif [ $score -ge 200 ]; then
              emoji="ðŸŸ¡"
              priority="MEDIUM"
            else
              emoji="ðŸŸ¢"
              priority="LOW"
            fi

            cat >> roadmap.md << ISSUE_BLOCK

          ### ${rank}. ${emoji} [#${number}](${url})

          **${title}**

          - **Priority:** ${priority} (Score: ${score})
          - **Labels:** ${labels}
          - **Action:** Review and assign owner

          ISSUE_BLOCK

            rank=$((rank + 1))
          done

          # Add footer
          cat >> roadmap.md << 'ROADMAP_FOOTER'

          ---

          ## ðŸ“Š Statistics

          - **Total sig/scheduling issues:** TOTAL_ISSUES_PLACEHOLDER
          - **Filtered to top:** 10 issues
          - **Analysis method:** Priority labels + type + keywords + age

          ---

          ## ðŸŽ¬ Recommended Actions

          1. **Immediate:** Assign owners to top 3 issues
          2. **This Week:** Create implementation plans for top 5
          3. **This Sprint:** Target completion of top 10

          ---

          ## ðŸ”— Resources

          - [All sig/scheduling Issues](https://github.com/kubernetes/kubernetes/issues?q=is%3Aopen+is%3Aissue+label%3Asig%2Fscheduling)
          - [SIG Scheduling Community](https://github.com/kubernetes/community/tree/master/sig-scheduling)
          - [Kubernetes Contributor Guide](https://github.com/kubernetes/community/tree/master/contributors/guide)

          ---

          *This roadmap is automatically updated every hour by GitHub Actions.*
          *Last updated: TIMESTAMP_PLACEHOLDER*
          ROADMAP_FOOTER

          sed -i "s/TOTAL_ISSUES_PLACEHOLDER/$TOTAL_ISSUES/g" roadmap.md
          sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" roadmap.md

          echo "âœ… Roadmap generated"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add roadmap.md

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)
            git commit -m "Update roadmap: Top 10 priority sig/scheduling issues

          Automated priority analysis of $TOTAL_ISSUES open issues.

          Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            git push
            echo "âœ… Roadmap pushed to repository"
          fi
