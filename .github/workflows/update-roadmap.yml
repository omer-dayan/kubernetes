name: Update Scheduler Roadmap with AI Analysis

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI
  push:
    branches:
      - master
    paths:
      - '.github/workflows/update-roadmap.yml'

jobs:
  update-roadmap:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch sig/scheduling issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Fetching sig/scheduling issues from kubernetes/kubernetes..."

          gh issue list \
            --repo kubernetes/kubernetes \
            --state open \
            --label "sig/scheduling" \
            --limit 100 \
            --json number,title,url,body,labels,createdAt,updatedAt > /tmp/issues.json

          TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)
          echo "Found $TOTAL_ISSUES sig/scheduling issues"

          # Create a concise summary for Claude
          jq -r '.[] | "Issue #\(.number): \(.title)\nLabels: \([.labels[]?.name] | join(", "))\nCreated: \(.createdAt)\nURL: \(.url)\nDescription: \(.body // "No description" | split("\n") | .[0:5] | join(" "))\n---"' \
            /tmp/issues.json > /tmp/issues_summary.txt

          echo "‚úÖ Issues fetched and summarized"

      - name: Analyze issues with Claude AI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Analyzing issues with Claude AI..."

          TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)
          ISSUES_SUMMARY=$(cat /tmp/issues_summary.txt)

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @- << EOF
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [{
              "role": "user",
              "content": "You are analyzing Kubernetes scheduler issues labeled with sig/scheduling. There are $TOTAL_ISSUES open issues.\n\nYour task:\n1. Analyze ALL issues for dependencies and relationships\n2. Identify which issues block or unblock others\n3. Determine the top 10 most critical issues based on:\n   - Technical impact\n   - Dependencies (issues that unblock many others)\n   - Priority labels\n   - Issue severity\n4. Create a strategic roadmap\n\nIssues to analyze:\n\n$ISSUES_SUMMARY\n\nProvide your response in this EXACT markdown format:\n\n# Kubernetes Scheduler - Strategic Roadmap\n\n**AI Analysis Date:** [current date]\n**Total Issues Analyzed:** $TOTAL_ISSUES\n**Analysis Model:** Claude Sonnet 4.5\n\n---\n\n## üéØ Executive Summary\n\n[2-3 sentence overview of the scheduler's current state and key challenges]\n\n---\n\n## üìä Dependency Analysis\n\n[Brief explanation of key dependencies discovered]\n\n---\n\n## üî• Top 10 Strategic Priorities\n\n[For each of top 10 issues, format as:]\n\n### 1. [Emoji] Issue #[number]: [Title]\n\n**Priority Level:** [Critical/High/Medium]\n**Impact:** [Describe technical impact]\n**Dependencies:** [List issues this blocks/unblocks]\n**Strategic Value:** [Why this is prioritized]\n**Recommended Action:** [Specific next step]\n**URL:** [issue url]\n\n---\n\n[Repeat for issues 2-10]\n\n---\n\n## üó∫Ô∏è Implementation Roadmap\n\n### Phase 1: Foundation (Weeks 1-2)\n[Issues that unblock others - list with rationale]\n\n### Phase 2: Core Features (Weeks 3-5)\n[Main feature work that depends on Phase 1]\n\n### Phase 3: Optimization (Weeks 6-8)\n[Polish and optimization work]\n\n---\n\n## üîó Issue Relationships\n\n[Describe key relationships between issues, dependencies discovered]\n\n---\n\n## üí° Strategic Recommendations\n\n1. [Key recommendation 1]\n2. [Key recommendation 2]\n3. [Key recommendation 3]\n\n---\n\n*This roadmap was generated using Claude AI analysis of sig/scheduling issues.*\n*For full issue list: https://github.com/kubernetes/kubernetes/issues?q=is%3Aopen+is%3Aissue+label%3Asig%2Fscheduling*"
            }]
          }
          EOF
          )

          # Extract the content from Claude's response
          echo "$RESPONSE" | jq -r '.content[0].text' > roadmap.md

          # Check if generation was successful
          if [ ! -s roadmap.md ]; then
            echo "‚ùå Failed to generate roadmap with Claude"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "‚úÖ AI analysis complete"

      - name: Commit and push roadmap
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add roadmap.md

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            TOTAL_ISSUES=$(jq '. | length' /tmp/issues.json)
            git commit -m "Update roadmap: AI-analyzed strategic priorities

          Claude AI analysis of $TOTAL_ISSUES sig/scheduling issues including:
          - Dependency analysis
          - Issue relationships
          - Strategic prioritization
          - Implementation roadmap

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

            git push
            echo "‚úÖ Roadmap pushed to repository"
          fi
